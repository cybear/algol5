{
  "meta": {
    "id": "descent",
    "name": "Descent",
    "source": "https://www.boardgamegeek.com/boardgame/150586/descent",
    "tags":[],
    "instructions": {
      "startTurn": "Select a unit to move and dig with",
      "selectunit": "Select where to move this unit",
      "selectmovetarget": ["concat",
        "Press \"move\" to ",
        ["ifelse",
          ["same",["read","units","selectunit","group"],["read","units","selectmovetarget","group"]],
          "walk",
          ["ifelse",
            ["or",
              ["anyat","rooks","selectunit"],
              ["anyat","pawns","selectmovetarget"]
            ],
            "descend",
            "climb"
          ]
        ],
        " from ",
        ["pos","selectunit"],
        " to ",
        ["pos","selectmovetarget"]
      ],
      "move": "Now select a neighbouring square to dig",
      "selectdigtarget": ["ifelse",
        ["anyat","rooks","selectdigtarget"],
        ["concat",
          "Press \"dig\" to turn ",["pos","selectdigtarget"]," from level 3 to level 2"
        ],
        ["ifelse",
          ["anyat","knights","selectdigtarget"],
          ["concat",
            "Press \"dig\" to turn ",["pos","selectdigtarget"]," from level 2 to level 1"
          ],
          ["concat","Press \"dig\" to destroy ",["pos","selectdigtarget"]]
        ]
      ]
    }
  },
  "graphics": {"icons": {"pawns":"pawns","knights":"knights","rooks":"rooks"} },
  "board": {
    "height": 4, "width": 4
  },
  "setup": {
    "rooks": {
      "0": [["rect","a2","d3"],"b4","c1"],
      "1": ["a1","c4","d1"],
      "2": ["a4","b1","d4"]
    }
  },
  "endGame": {
    "madeline": {"condition":["notempty","winline"]}
  },
  "startTurn": {
    "link": "selectunit"
  },
  "marks": {
    "selectunit": {
      "from": "myunits",
      "runGenerator": "findmovetargets",
      "link": "selectmovetarget"
    },
    "selectmovetarget": {
      "from": "movetargets",
      "link": "move"
    },
    "selectdigtarget": {
      "from": "digtargets",
      "link": "dig"
    }
  },
  "commands": {
    "move": {
      "runGenerator": "finddigtargets",
      "applyEffects": [
        ["setturnpos","movedto","selectmovetarget"],
        ["setturnvar","heightfrom",["read","units","selectunit","group"]],
        ["setturnvar","heightto",["read","units","selectmovetarget","group"]],
        ["setat","selectunit","group",["turnvar","heightto"]],
        ["killat","selectmovetarget"],
        ["moveat","selectunit","selectmovetarget"],
        ["spawn","selectunit",["turnvar","heightfrom"],0]
      ],
      "link": "selectdigtarget"
    },
    "dig": {
      "applyEffect": ["ifelse",
        ["anyat","pawns","selectdigtarget"],
        ["killat","selectdigtarget"],
        ["setat","selectdigtarget","group",["ifelse",
          ["anyat","knights","selectdigtarget"],
          "pawns",
          "knights"
        ]]
      ],
      "runGenerator": "findwinlines",
      "link": "endturn"
    }
  },
  "generators": {
    "findmovetargets": {
      "type": "neighbour",
      "start": "selectunit",
      "condition": ["ifelse",
        ["anyat","rooks","selectunit"],
        ["noneat","pawns",["target"]],
        ["ifelse",
          ["anyat","pawns","selectunit"],
          ["noneat","rooks",["target"]],
          ["true"]
        ]
      ],
      "draw": {
        "neighbours": {
          "ifover": "neutralunits",
          "tolayer": "movetargets"
        }
      }
    },
    "finddigtargets": {
      "type": "neighbour",
      "start": ["turnpos","movedto"],
      "ifover": "neutralunits",
      "draw": {
        "neighbours": {
          "tolayer": "digtargets"
        }
      }
    },
    "findwinlines": {
      "type": "walker",
      "starts": "myunits",
      "steps": ["ifelse",
        ["anyat","myrooks",["start"]],
        "myrooks",
        ["ifelse",
          ["anyat","myknights",["start"]],
          "myknights",
          "mypawns"
        ]
      ],
      "draw": {
        "steps": {
          "condition": ["morethan",["walklength"],1],
          "tolayer": "winline"
        }
      }
    }
  }
}