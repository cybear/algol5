{
  "meta": {
    "id": "murusgallicusadvanced",
    "name": "Murus Gallicus Advanced",
    "source": "https://boardgamegeek.com/thread/844020/advanced-murus-gallicus",
    "tags": ["differentunits","infiltrate","shoot"],
    "author": "Phillip L. Leduc",
    "instructions": {
      "startTurn": ["line","Select a",["orlist",[["notempty","mytowers"],"rook"],[["notempty","mycatapults"],"queen"]],"to act with"],
      "selecttower": ["line",
        "Select",["orlist",
          [["notempty","movetargets"],"a move target"],
          [["notempty","killtargets"],["line","an enemy","pawn","to kill"]]
        ],
        "for the","selecttower","rook"
      ],
      "selectmove": ["line","Press","move","to overturn your","selecttower","rook","towards","selectmove"],
      "selectkill": ["line",
        "Press","kill","to make a section of the","selecttower","rook",
        ["ifelse",
          ["anyat","walls","selectkill"],
          ["line","crush the enemy","pawn","at","selectkill"],
          ["line","reduce the enemy","queen","at","selectkill","to a","rook",", or","sacrifice","your","rook","entirely to turn the","queen","to a","pawn","!"]
        ]
      ],
      "selectcatapult": ["line","Select where to fire the top section of your","selectcatapult","queen"],
      "selectfire": ["line",
        "Press","fire","to shoot a section of the","selectcatapult","queen",
        ["ifelse",
          ["anyat","walls","selectfire"],
          ["line","and destroy the enemy","pawn","at","selectfire"],
          ["ifelse",
            ["anyat","units","selectfire"],
            [", reducing the enemy",["unitnameat","selectfire"],"at","selectfire","to a",["ifelse",["anyat","catapults","selectfire"],"rook","pawn"]],
            ["line","at","selectfire",", gaining a","pawn","there"]
          ]
        ]
      ]
    }
  },
  "graphics": { "tiles": {"homerow":"playercolour"}, "icons": {"towers":"rook","walls":"pawn","catapults":"queen"} },
  "board": {
    "height": 7, "width": 8,
    "terrain": { "homerow": { "1": [["rect","a1","h1"]], "2":[["rect","a7","h7"]] } }
  },
  "setup": { "towers": { "1": [["rect","a1","h1"]], "2":[["rect","a7","h7"]] } },
  "startTurn": {
    "links": ["selecttower","selectcatapult"]
  },
  "endGame": {
    "infiltration": {"condition":["overlaps","myunits","opphomerow"],"show":["intersect","myunits","opphomerow"]}
  },
  "marks": {
    "selecttower": {
      "from": "mytowers",
      "runGenerators": ["findmovetargets","findkilltargets"],
      "links": ["selectmove","selectkill"]
    },
    "selectmove": {
      "from": "movetargets",
      "runGenerator": "findmoveresults",
      "link": "move"
    },
    "selectkill": {
      "from": "killtargets",
      "links": ["kill",["if",["anyat","oppcatapults","selectkill"],"sacrifice"]]
    },
    "selectcatapult": {
      "from": "mycatapults",
      "runGenerator": "findfiretargets",
      "link": "selectfire"
    },
    "selectfire": {
      "from": "firetargets",
      "link": "fire"
    }
  },
  "commands": {
    "move": {
      "applyEffects": [
        ["killat","selecttower"],
        ["forposin","madecatapults",["setat",["target"],"group","catapults"]],
        ["forposin","madetowers",["setat",["target"],"group","towers"]],
        ["forposin","madewalls",["spawn",["target"],"walls",["player"],{"from":["pos","selecttower"]}]]
      ],
      "link": "endturn"
    },
    "kill": {
      "applyEffects": [
        ["setat","selecttower","group","walls"],
        ["ifelse",
          ["anyat","oppcatapults","selectkill"],
          ["setat","selectkill","group","towers"],
          ["killat","selectkill"]
        ]
      ],
      "link": "endturn"
    },
    "sacrifice": {
      "applyEffects": [
        ["setat","selectkill","group","walls"],
        ["killat","selecttower"]
      ],
      "link": "endturn"
    },
    "fire": {
      "applyEffects": [
        ["ifelse",
          ["anyat","oppwalls","selectfire"],
          ["killat","selectfire"],
          ["ifelse",
            ["anyat","oppunits","selectfire"],
            ["setat","selectfire","group",["ifelse",["anyat","oppcatapults","selectfire"],"towers","walls"]],
            ["spawn","selectfire","walls",["player"],{"from":["pos","selectcatapult"]}]
          ]
        ],
        ["setat","selectcatapult","group","towers"]
      ],
      "link": "endturn"
    }
  },
  "generators": {
    "findfiretargets": {
      "type": "walker",
      "start": "selectcatapult",
      "dirs": ["playercase",[7,8,1,2,3],[3,4,5,6,7]],
      "max": 3,
      "draw": {
        "steps": {
          "condition": ["and",
            ["morethan",["step"],1],
            ["noneat","myunits",["target"]]
          ],
          "tolayer": "firetargets"
        }
      }
    },
    "findmovetargets": {
      "type": "walker",
      "blocks": ["union","oppunits","mycatapults"],
      "start": "selecttower",
      "dirs": [1,2,3,4,5,6,7,8],
      "max": 2,
      "draw": {
        "steps": {
          "condition": ["and",
            ["same",["walklength"],2],
            ["same",["step"],2]
          ],
          "tolayer": "movetargets",
          "include": {"dir":["dir"]}
        }
      }
    },
    "findmoveresults": {
      "type": "neighbour",
      "dir": ["reldir",5,["read","movetargets","selectmove","dir"]],
      "start": "selectmove",
      "draw": {
        "start": {
          "tolayer": ["ifelse",
            ["anyat","myunits","selectmove"],
            ["ifelse",
              ["anyat","mytowers","selectmove"],
              "madecatapults",
              "madetowers"
            ],
            "madewalls"
          ]
        },
        "neighbours": {
          "tolayer": ["ifelse",
            ["anyat","myunits",["target"]],
            ["ifelse",
              ["anyat","mytowers",["target"]],
              "madecatapults",
              "madetowers"],
            "madewalls"
          ]
        }
      }
    },
    "findkilltargets": {
      "type": "neighbour",
      "start": "selecttower",
      "dirs": [1,2,3,4,5,6,7,8],
      "ifover": ["union","oppcatapults","oppwalls"],
      "draw": {
        "neighbours": {
          "tolayer": "killtargets"
        }
      }
    }
  }
}